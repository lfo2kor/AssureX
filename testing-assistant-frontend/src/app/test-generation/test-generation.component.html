<div class="header-container">
  <hr class="hr" />
  <div class="tab-container">
    <button class="custom-button" (click)="switchTab('tab1')">New Chat</button>
    <button class="custom-button" (click)="switchTab('tab2')">History</button>
  </div>
</div>

<div class="page-container" [ngClass]="{'history-active': activeTab === 'tab2'}">
  <div class="content-area">
    
    <div *ngIf="activeTab === 'tab1'" class="bottom-section">
      <div class="chat-container" *ngIf="currentChatMessages.length > 0" #chatContainer>
        <div *ngFor="let message of currentChatMessages" class="message-wrapper">
          <div class="user-message" *ngIf="message.type === 'user'">
            <div class="message-content user-content">
              <div class="message-text">{{ message.text }}</div>
              <div class="message-images" *ngIf="message.images && message.images.length > 0">
                <img *ngFor="let img of message.images" [src]="img" class="message-image" alt="user image">
              </div>
            </div>
            <mat-icon class="user-icon">account_circle</mat-icon>
          </div>

          <div class="bot-message-wrapper" *ngIf="message.type === 'bot'">
            <div class="bot-message">
              <mat-icon class="bot-icon">auto_awesome</mat-icon>
              <div class="message-content bot-content">
                <div class="message-text" *ngIf="message.text && !message.ticketDetails && !message.waitingForConfirmation && !message.isRunning && !message.executionStatus">
                  {{ message.text }}
                </div>
                <div class="ticket-details-card" *ngIf="message.ticketDetails && !message.executionStatus">
                  <div class="detail-row">
                    <strong>Found JIRA ticket:</strong> {{ message.ticketDetails.ticket_id }}
                  </div>
                  <br>
                  <div class="detail-row">
                    <strong>Title:</strong> {{ message.ticketDetails.title }}
                  </div>
                  <div class="detail-row scripts-info" *ngIf="message.hasExistingScripts && message.scriptsCount && message.scriptsCount > 0">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2">
                      <polyline points="16 18 22 12 16 6"></polyline>
                      <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    <strong>Test Script Available to Rerun</strong>
                  </div>
                </div>
                <div class="yes-no-buttons" *ngIf="message.waitingForConfirmation">
                  <button class="yes-button" (click)="onRunTestClick(message)" title="Generate and Run Testcase">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 5v14M5 12h14"></path>
                    </svg>
                    Generate and Run Testcase
                  </button>
                  <button class="generate-button" (click)="onRerunTestClick(message)" title="Rerun Testcase using existing script">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                    Rerun Testcase
                    <span class="no-script-badge" *ngIf="!message.hasExistingScripts || !message.scriptsCount" title="No scripts found for this ticket">‚ö†Ô∏è</span>
                  </button>
                </div>
                
                <!-- Execution Container - Only show loader while running -->
                <div class="execution-container" 
                     [ngClass]="{'execution-complete': message.executionStatus && !message.isRunning}"
                     *ngIf="message.isRunning || message.executionProgress || message.executionStatus">
                  <div class="execution-header" *ngIf="message.isRunning">
                    <span class="execution-title">Test Execution in Progress</span>
                  </div>
                  
                  <div class="running-status" *ngIf="message.isRunning">
                    <div class="a-activity-indicator compact" aria-live="off">
                      <div class="a-activity-indicator__top-box"></div>
                      <div class="a-activity-indicator__bottom-box"></div>
                    </div>
                    <span class="status-text">Running tests... Please wait.</span>
                  </div>
                </div>
                
                <!-- Execution Complete Section - Only show after completion -->
                <div *ngIf="message.executionStatus && !message.isRunning">
                  <div class="execution-result success">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20,6 9,17 4,12"></polyline>
                    </svg>
                    <span>Execution Complete</span>
                  </div>

                  <div class="test-summary-section compact" *ngIf="message.summary && message.showSummary">
                    <div class="summary-header" (click)="toggleSummary(message)">
                      <h3 class="summary-title">
                        <mat-icon>assessment</mat-icon>
                        Test Execution Summary
                      </h3>
                      <button class="toggle-summary-btn">
                        <mat-icon>{{ message.showSummary ? 'expand_less' : 'expand_more' }}</mat-icon>
                      </button>
                    </div>

                    <div class="summary-content" *ngIf="message.showSummary">
                      <!-- Overall Status Card -->
                      <div class="summary-card main-status" [ngClass]="getStatusColorClass(message.summary.summary.overall_status)">
                        <div class="card-icon">{{ message.summary.insights.status_emoji }}</div>
                        <div class="card-content">
                          <div class="card-label">Overall Status</div>
                          <div class="card-value">{{ message.summary.summary.overall_status }}</div>
                        </div>
                      </div>

                      <!-- Metrics Grid -->
                      <div class="metrics-grid">
                        <div class="metric-card">
                          <div class="metric-icon">üìä</div>
                          <div class="metric-content">
                            <div class="metric-label">Total Steps</div>
                            <div class="metric-value">{{ message.summary.summary.total_steps }}</div>
                          </div>
                        </div>

                        <div class="metric-card success">
                          <div class="metric-icon">‚úÖ</div>
                          <div class="metric-content">
                            <div class="metric-label">Passed</div>
                            <div class="metric-value">{{ message.summary.summary.passed }}</div>
                          </div>
                        </div>

                        <div class="metric-card failed" *ngIf="message.summary.summary.failed > 0">
                          <div class="metric-icon">‚ùå</div>
                          <div class="metric-content">
                            <div class="metric-label">Failed</div>
                            <div class="metric-value">{{ message.summary.summary.failed }}</div>
                          </div>
                        </div>

                        <div class="metric-card" *ngIf="message.summary.summary.skipped > 0">
                          <div class="metric-icon">‚è≠Ô∏è</div>
                          <div class="metric-content">
                            <div class="metric-label">Skipped</div>
                            <div class="metric-value">{{ message.summary.summary.skipped }}</div>
                          </div>
                        </div>

                        <div class="metric-card">
                          <div class="metric-icon">‚è±Ô∏è</div>
                          <div class="metric-content">
                            <div class="metric-label">Execution Time</div>
                            <div class="metric-value">{{ message.summary.summary.execution_time }}</div>
                          </div>
                        </div>

                        <div class="metric-card">
                          <div class="metric-icon">üéØ</div>
                          <div class="metric-content">
                            <div class="metric-label">Avg Confidence</div>
                            <div class="metric-value">{{ (message.summary.summary.avg_confidence * 100).toFixed(0) }}%</div>
                          </div>
                        </div>
                      </div>

                      <!-- Critical Failures (if any) -->
                      <div class="critical-failures-section" *ngIf="message.summary.insights.critical_failures.length > 0">
                        <h4 class="section-title error">
                          <mat-icon>error</mat-icon>
                          Critical Failures
                        </h4>
                        <div class="failure-card" *ngFor="let failure of message.summary.insights.critical_failures">
                          <div class="failure-step">Step {{ failure.step_number }}: {{ failure.step_text }}</div>
                          <div class="failure-error">{{ failure.error }}</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Show summary toggle button if summary exists but is hidden -->
                  <button class="show-summary-btn" 
                          *ngIf="message.summary && !message.showSummary" 
                          (click)="toggleSummary(message)">
                    <mat-icon>assessment</mat-icon>
                    View Test Summary
                  </button>

                  <div class="download-actions" *ngIf="message.reportGenerated && message.executionId">
                    <h4 class="download-title">Download Generated Files</h4>
                    <div class="download-buttons">
                      <button class="download-btn report-btn" (click)="downloadReport(message)" title="Download HTML Report" style="background-color: #b0e4b0">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                          <polyline points="14 2 14 8 20 8"></polyline>
                          <line x1="16" y1="13" x2="8" y2="13"></line>
                          <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        HTML Report
                      </button>
                      <button class="download-btn script-btn" (click)="downloadScript(message)" title="Download Playwright Script" style="background-color: #b0e4b0">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="16 18 22 12 16 6"></polyline>
                          <polyline points="8 6 2 12 8 18"></polyline>
                        </svg>
                        Playwright Script
                      </button>
                      <button class="download-btn video-btn" (click)="downloadVideo(message)" title="Download Test Video" style="background-color: #b0e4b0">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polygon points="23 7 16 12 23 17 23 7"></polygon>
                          <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg>
                        Test Video
                      </button>
                    </div>
                    
                    <div class="generated-files-list" *ngIf="message.generatedFiles && message.generatedFiles.length > 0">
                      <div class="files-header">üìÅ Generated Files:</div>
                      <div class="file-item" *ngFor="let file of message.generatedFiles">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" *ngIf="file">
                          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                          <polyline points="13 2 13 9 20 9"></polyline>
                        </svg>
                        <span class="file-name">{{ file | slice:-50 }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="external-message-actions">
              <button class="action-button like-btn" (click)="onLike(message)" [class.active]="message.liked" title="Like this response">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                </svg>
              </button>
              <button class="action-button dislike-btn" (click)="onDislike(message)" [class.active]="message.disliked" title="Dislike this response">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm0 0V6H2.5L2 15"></path>
                </svg>
              </button>
              <button class="action-button copy-btn" (click)="onCopy(message)" [class.copied]="message.copied" title="Copy response">
                <svg *ngIf="!message.copied" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg *ngIf="message.copied" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20,6 9,17 4,12"></polyline>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="welcome-message" *ngIf="currentChatMessages.length === 0">
         <h2 *ngIf="username" class="greeting">Hi {{ username }}! Welcome to AI Test Assistant</h2>
        <div class="welcome-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#2196f3" stroke-width="1.5">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </div>
        <p>Enter a JIRA ticket number to start automated test generation</p>
        <div class="example-tickets">
          <span class="example-label">Examples:</span>
          <code>RBPLCD-8835</code>
          <code>TEST-001</code>
          <code>PROJ-123</code>
        </div>
      </div>
      <div class="load-con" *ngIf="loading">
        <div class="a-activity-indicator service-list-loader" aria-live="off">
          <div class="a-activity-indicator__top-box"></div>
          <div class="a-activity-indicator__bottom-box"></div>
        </div>
        <p class="loading-text">Fetching ticket details...</p>
      </div>
      <div class="textarea-wrapper" [class.disabled]="hasPlaywrightScript()">
        <div class="new-chat-message" *ngIf="hasPlaywrightScript()">
          <div class="info-text">
            ‚úÖ Test completed! To run another test,
            <button class="inline-new-chat-btn" (click)="switchTab('tab1')">
              <mat-icon>add</mat-icon>
              Start New Chat
            </button>
          </div>
        </div>
        <div class="a-text-area" *ngIf="!hasPlaywrightScript()">
          <textarea id="messageInput"
                    #messageTextarea
                    placeholder="Enter JIRA Ticket ID (e.g., ABCD-1234)"
                    (keydown)="onEnterPress($event)"
                    [(ngModel)]="currentMessage"
                    [disabled]="loading"></textarea>
          <div class="send-icon" *ngIf="!loading" (click)="submitMessage()" [class.disabled]="!currentMessage.trim()">
            <mat-icon>send</mat-icon>
          </div>
          <div class="loading-spinner" *ngIf="loading"></div>
        </div>
      </div>
    </div>
    <div *ngIf="activeTab === 'tab2'" class="bottom-section">
      <div class="load-con" *ngIf="aborting">
        <div class="a-activity-indicator service-list-loader" aria-live="off">
          <div class="a-activity-indicator__top-box"></div>
          <div class="a-activity-indicator__bottom-box"></div>
        </div>
      </div>
      <div class="welcome-banner -size-xl" *ngIf="!aborting">
        Test Generation History
      </div>
    </div>
  </div>
</div>
<div class="history-section" *ngIf="activeTab === 'tab2'">
  <span class="breadcrumb1">
    <span class="breadcrumb-link1" (click)="switchTab('tab1')">
      AI Test Assistant
    </span>
    &nbsp;>&nbsp;
    <span class="breadcrumb1-current">History</span>
  </span>
  <div class="empty-history" *ngIf="chatHistories.length === 0">
    <mat-icon class="empty-icon">history</mat-icon>
    <p>No chat history yet</p>
    <p class="empty-subtitle">Start a new conversation to see it here</p>
  </div>
  <div *ngFor="let chat of chatHistories; let i = index" class="history-item" (click)="selectChat(i)">
    <div class="history-item-content">
      <span class="history-title"
            [attr.contenteditable]="editingIndex === i"
            (blur)="saveEdit(i, $event)"
            (keydown.enter)="saveEdit(i, $event)"
            (keydown.escape)="cancelEdit(i, $event)"
            (click)="$event.stopPropagation()"
            [title]="chat.title">
        {{ editingIndex === i ? chat.title : (chat.title.length > 100 ? chat.title.substring(0, 100) + '...' : chat.title) }}
      </span>
    </div>
    <div class="history-actions">
      <ng-container *ngIf="editingIndex !== i; else editActions">
        <button class="action-btn view-btn" (click)="viewChat(i, $event)" title="View">
          <mat-icon>visibility</mat-icon>
        </button>
        <button class="action-btn edit-btn" (click)="startEdit(i, $event)" title="Edit">
          <mat-icon>edit</mat-icon>
        </button>
        <div class="frontend-kit-example_modal-dialog">
          <button class="action-btn delete-btn" type="button" (click)="showDialog(i, dialog, $event)" title="Delete">
            <mat-icon>delete</mat-icon>
          </button>
          <dialog #dialog class="m-dialog -floating-shadow-s -primary" aria-labelledby="dialog-default-non-modal-dialog-title">
            <div class="m-dialog__header">
              <div class="m-dialog__title">Do you want to delete this chat?</div>
              <button type="button" class="a-button a-button--integrated -without-label" (click)="closeDialog1(dialog, $event)" aria-label="close dialog">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <hr class="a-divider" />
            <div class="m-dialog__content">
              <div class="m-dialog__body">
                This will delete
                <b>{{ selectedIndex !== null ? chatHistories[selectedIndex].title : '' }}</b>
                You'll no longer see this chat.
              </div>
              <div class="m-dialog__actions">
                <button type="button" class="a-button a-button--primary -without-icon" (click)="onConfirm(dialog, $event)" [disabled]="deletingSessionId !== null">
                  <span class="a-button__label">{{ deletingSessionId ? 'Deleting...' : 'Delete' }}</span>
                </button>
                <button type="button" class="a-button a-button--secondary -without-icon" (click)="closeDialog1(dialog, $event)" [disabled]="deletingSessionId !== null">
                  <span class="a-button__label">Cancel</span>
                </button>
              </div>
            </div>
          </dialog>
        </div>
      </ng-container>
      <ng-template #editActions>
        <button class="action-btn save-btn" (click)="saveEdit(i, $event)" title="Save">
          <mat-icon>check</mat-icon>
        </button>
        <button class="action-btn cancel-btn" (click)="cancelEdit(i, $event)" title="Cancel">
          <mat-icon>close</mat-icon>
        </button>
      </ng-template>
    </div>
  </div>
</div>